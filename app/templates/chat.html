{% extends "base.html" %}
{% block content %}
  <h1>The Reward Collection GPT</h1>
  <form id="chat-form" method="post" action="{{ url_for('ask') }}" style="display:flex;flex-direction:column;width:70%;margin:auto;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <textarea name="message" placeholder="Ask something" required style="background:#222;border:1px solid #555;color:#eee;padding:.5rem;height:6rem;"></textarea>
    <button type="submit" style="align-self:flex-end;margin-top:.5rem;padding:.5rem 1rem;background:#0ff;border:none;color:#000;">Send</button>
  </form>
  <div id="answer" style="margin:1rem 0;font-style:italic;"></div>
  <div id="chat" style="max-width:600px;margin:0 auto 2rem;">
    {% for m in messages %}
      <div class="msg {{ m.role }}">{{ m.role }}: {{ m.content }}</div>
    {% endfor %}
  </div>
  <script>
    async function postForm(action, data) {
      const resp = await fetch(action, {method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams(data)});
      return resp.json();
    }
    document.getElementById('chat-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const text = form.message.value;
      const csrf = form.csrf_token.value;
      const data = await postForm(form.action, {message: text, csrf_token: csrf});
      const chat = document.getElementById('chat');
      chat.insertAdjacentHTML('beforeend', `<div class="msg user">user: ${text}</div>`);
      chat.insertAdjacentHTML('beforeend', `<div class="msg assistant">assistant: ${data.answer}</div>`);
      document.getElementById('answer').textContent = data.answer;
      form.message.value = '';
    });
  </script>
{% endblock %}
